<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ù‚Ø´Ù‡ Ø¬Ù‡Ø§Ù† - TextEmpire</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Tahoma', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            direction: rtl;
        }
        
        .header {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #4CAF50;
        }
        
        .controls {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn.active {
            background: #ff9800;
        }
        
        #map {
            height: 400px;
            width: 100%;
            border: 2px solid #4CAF50;
        }
        
        .info-panel {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            border: 1px solid #4CAF50;
        }
        
        .country-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
        }
        
        .country-item {
            padding: 5px;
            margin: 2px 0;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .country-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .relation-friend { color: #4CAF50; }
        .relation-neutral { color: #ff9800; }
        .relation-enemy { color: #f44336; }
        .relation-me { color: #2196F3; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h2>ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ø¬Ù‡Ø§Ù† - TextEmpire</h2>
        <p id="user-info">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
    </div>
    
    <div class="controls">
        <button class="btn" onclick="showCountries()">ğŸ“ Ú©Ø´ÙˆØ±Ù‡Ø§</button>
        <button class="btn" onclick="showRelations()">ğŸ¤ Ø±ÙˆØ§Ø¨Ø·</button>
        <button class="btn" onclick="showDistance()">ğŸ“ ÙØ§ØµÙ„Ù‡</button>
        <button class="btn" onclick="resetMap()">ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ</button>
    </div>
    
    <div id="map"></div>
    
    <div class="info-panel">
        <h3>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù‚Ø´Ù‡</h3>
        <div id="map-info">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    </div>
    
    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù‚Ø´Ù‡
        let map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² API
        const API_BASE = "https://textempire-map.onrender.com";

        let countries = [];
        let currentUser = '712413375726'; // Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ
        
        // Ø¯Ø±ÛŒØ§ÙØª Ú©Ø´ÙˆØ±Ù‡Ø§ Ø§Ø² API
        fetch('/api/countries')
            .then(response => response.json())
            .then(data => {
                countries = data;
                showCountries();
            })
            .catch(error => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
                countries = [
                    {name: 'Ø§ÛŒØ±Ø§Ù†', lat: 32.4279, lng: 53.6880, user: '712413375726', relation: 0},
                    {name: 'ÙØ±Ø§Ù†Ø³Ù‡', lat: 46.2276, lng: 2.2137, user: '123456789', relation: 60},
                    {name: 'Ø¢Ù„Ù…Ø§Ù†', lat: 51.1657, lng: 10.4515, user: '987654321', relation: -30},
                    {name: 'Ø¨Ø±Ø²ÛŒÙ„', lat: -14.2350, lng: -51.9253, user: '555666777', relation: 20}
                ];
                showCountries();
            });
        
        let markers = [];
        
        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
        document.getElementById('user-info').innerHTML = `ğŸ‘¤ Ø´Ù…Ø§: ${currentUser} - Ø§ÛŒØ±Ø§Ù†`;
        
        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ú©Ø´ÙˆØ±Ù‡Ø§
        function showCountries() {
            clearMarkers();
            countries.forEach(country => {
                let color = country.user === currentUser ? '#2196F3' : '#4CAF50';
                let marker = L.marker([country.lat, country.lng])
                    .bindPopup(`<b>${country.name}</b><br>Ú©Ø§Ø±Ø¨Ø±: ${country.user}`)
                    .addTo(map);
                markers.push(marker);
            });
            updateInfo('ğŸ“ Ú©Ø´ÙˆØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯');
        }
        
        // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆØ§Ø¨Ø·
        function showRelations() {
            clearMarkers();
            countries.forEach(country => {
                let color, relationText;
                if (country.user === currentUser) {
                    color = '#2196F3';
                    relationText = 'Ø´Ù…Ø§';
                } else if (country.relation >= 60) {
                    color = '#4CAF50';
                    relationText = 'Ø¯ÙˆØ³Øª';
                } else if (country.relation >= -20) {
                    color = '#ff9800';
                    relationText = 'Ø®Ù†Ø«ÛŒ';
                } else {
                    color = '#f44336';
                    relationText = 'Ø¯Ø´Ù…Ù†';
                }
                
                let marker = L.marker([country.lat, country.lng])
                    .bindPopup(`<b>${country.name}</b><br>Ø±ÙˆØ§Ø¨Ø·: ${relationText} (${country.relation})`)
                    .addTo(map);
                markers.push(marker);
            });
            updateInfo('ğŸ¤ Ø±ÙˆØ§Ø¨Ø· Ø¯ÛŒÙ¾Ù„Ù…Ø§ØªÛŒÚ© Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯');
        }
        
        // ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡
        function showDistance() {
            clearMarkers();
            let userCountry = countries.find(c => c.user === currentUser);
            if (!userCountry) return;
            
            // Ù†Ù…Ø§ÛŒØ´ Ú©Ø´ÙˆØ± Ú©Ø§Ø±Ø¨Ø±
            let userMarker = L.marker([userCountry.lat, userCountry.lng], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #2196F3; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).bindPopup(`<b>${userCountry.name}</b><br>Ø´Ù…Ø§`).addTo(map);
            markers.push(userMarker);
            
            // Ù†Ù…Ø§ÛŒØ´ Ø³Ø§ÛŒØ± Ú©Ø´ÙˆØ±Ù‡Ø§ Ùˆ Ø®Ø·ÙˆØ· ÙØ§ØµÙ„Ù‡
            countries.forEach(country => {
                if (country.user !== currentUser) {
                    let distance = calculateDistance(userCountry.lat, userCountry.lng, country.lat, country.lng);
                    let marker = L.marker([country.lat, country.lng])
                        .bindPopup(`<b>${country.name}</b><br>ÙØ§ØµÙ„Ù‡: ${Math.round(distance)} Ú©ÛŒÙ„ÙˆÙ…ØªØ±`)
                        .addTo(map);
                    markers.push(marker);
                    
                    // Ø®Ø· ÙØ§ØµÙ„Ù‡
                    let line = L.polyline([[userCountry.lat, userCountry.lng], [country.lat, country.lng]], {
                        color: '#ff9800',
                        weight: 2,
                        opacity: 0.7
                    }).addTo(map);
                    markers.push(line);
                }
            });
            updateInfo('ğŸ“ ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯');
        }
        
        // ØªØ§Ø¨Ø¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Ø´Ø¹Ø§Ø¹ Ø²Ù…ÛŒÙ† Ø¯Ø± Ú©ÛŒÙ„ÙˆÙ…ØªØ±
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // ØªØ§Ø¨Ø¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø§Ø±Ú©Ø±Ù‡Ø§
        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù†Ù‚Ø´Ù‡
        function resetMap() {
            clearMarkers();
            map.setView([20, 0], 2);
            updateInfo('ğŸ”„ Ù†Ù‚Ø´Ù‡ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯');
        }
        
        // ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        function updateInfo(text) {
            document.getElementById('map-info').innerHTML = `
                <p>${text}</p>
                <p>ğŸ“ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø´ÙˆØ±Ù‡Ø§: ${countries.length}</p>
                <p>ğŸ• Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${new Date().toLocaleTimeString('fa-IR')}</p>
            `;
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø´ÙˆØ±Ù‡Ø§
        showCountries();
    </script>
</body>
</html> 
